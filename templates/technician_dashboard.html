<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}
    Technician Dashboard
    {% endblock %}
  </title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Lightbox CSS -->
<link href="https://cdn.jsdelivr.net/npm/lightbox2@2.11.3/dist/css/lightbox.min.css" rel="stylesheet">


  <!-- FontAwesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="{% static 'assets/img/kaiadmin/favicon.ico' %}" type="image/x-icon" />
  <!-- External CSS -->
  <link rel="stylesheet" href="{% static 'assets/css/admin_dashboard.css' %}">

  <style>
    .icon-container {
      display: flex;
      align-items: center;
      justify-content: center; /* Center the icons horizontally */
  }
  
  .icon-container a {
      color: black;
      font-size: 20px; /* Reduced size */
  }
  
  .icon-container a:first-child {
      margin-right: 10px; /* Space after the first icon */
  }
  
  .icon-container a:last-child {
      margin-top: 9px;
      margin-left: 10px; /* Space before the second icon */
  }
  
  .icon-container a:hover {
      color: #555; /* Darker shade on hover (optional) */
  }

 

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 30px;
    left: 0;
    background-color: #f9f9f9;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    min-width: 200px;
    z-index: 10;
  }
  
  .dropdown-item {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: black;
  }
  
  .dropdown-item:hover {
    background-color: #f1f1f1;
  }
  
  .icon-link {
    cursor: pointer;
    font-size: 24px;
    margin-right: 10px;
  }
  
  .icon-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }


  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="d-flex align-items-center">
      <!-- Logo -->
      <a href="#" class="logo">
        <img src="{% static 'assets/img/velvetek.jpg' %}" alt="navbar brand" />
      </a>
      <!-- Hamburger Menu -->
      <span class="hamburger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </span>
    </div>
    <!-- Admin text on the right side -->
    <span class="admin-text">Hi,{{user.username}}</span>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Technician Dashboard</h5>
    <a href="{% url 'technician_dashboard' %}"><i class="fas fa-home"></i> Home</a>

    
    <a href="#" onclick="openModal()" ><i class="fas fa-tools" ></i> Add Service</a>

    <a href="#" onclick="openCustomerModal()"><i class="fas fa-user-plus"></i> Add Customer</a>
   
    <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Cards Section -->
    <div class="row">
      <div class="col-md-4">
        <div class="card p-3 mb-3">
          <div class="d-flex align-items-center">
            <i class="fas fa-users card-icon me-3"></i>
            <div>
              <h3 class="mb-1">Total Task</h3>
            </div>
            <h1 class="ms-auto mb-0">{{ total_services }}</h1>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 mb-3">
          <div class="d-flex align-items-center">
            <i class="fas fa-user-cog card-icon me-3"></i>
            <div>
              <h3 class="mb-1">Pending Task</h3>
            </div>
            <h1 class="ms-auto mb-0">{{ pending_task }}</h1>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 mb-3">
          <div class="d-flex align-items-center">
            <i class="fas fa-tools card-icon me-3"></i>
            <div>
              <h3 class="mb-1">Completed task</h3>
            </div>
            <h1 class="ms-auto mb-0">{{ completed_task }}</h1>
          </div>
        </div>
      </div>
    </div>
 {% block content %}

    <!-- Tasks Section -->
    <h3 class="mt-0 mb-2">Tasks</h3>
    <div class="navbar">
      <div class="nav-left">
        <a href="{% url 'switch_tasks'  %}" class="filter-option {% if current_filter != 'Assigned' and current_filter != 'Pending' and current_filter != 'Completed' %}selected{% endif %}">All Tasks</a>
        <a href="{% url 'switch_tasks_filter' status='Assigned' %}" class="filter-option {% if current_filter == 'Assigned' %}selected{% endif %}">Assigned</a>
        <a href="{% url 'switch_tasks_filter' status='Pending' %}" class="filter-option {% if current_filter == 'Pending' %}selected{% endif %}">Pending</a>
        <a href="{% url 'switch_tasks_filter' status='Completed' %}" class="filter-option {% if current_filter == 'Completed' %}selected{% endif %}">Completed</a>
      </div>
      <div class="nav-right">
        <button class="btn btn-primary btn-sm" onclick="openModal()">Add Service</button>
      </div>
    </div>
  
    <!-- Add Service Modal -->
<div id="addServiceModal" class="modal">
  <div class="modal-content">
    <!-- Top Bar -->
    <div class="modal-topbar">
      <h2>Add Service</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>

    <form id="addServiceForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-grid">
        <!-- Column 1 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="contact_number">Customer Number</label>
            <input type="text" id="contact_number" name="contact_number" oninput="searchCustomer()">
            <div id="customer_results"></div>
            <div id="customer_not_found" class="text-danger" style="display: none;">Customer not found. Please enter details manually.</div>
            <small id="customer_error" class="text-danger"></small>
          </div>
          <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" readonly>
          </div>
          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address" readonly>
          </div>
          <div class="form-group">
            <label for="whatsapp_number">WhatsApp Number</label>
            <input type="text" id="whatsapp_number" name="whatsapp_number" readonly>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="same_as_contact" onchange="copyContactToWhatsApp()">
            <label for="same_as_contact">Same as Contact Number</label>
          </div>
          <div class="form-group">
            <label for="referred_by">Referred By</label>
            <input type="text" id="referred_by" name="referred_by" readonly>
          </div>
        </div>

        <!-- Column 2 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="service_by">Service By</label>
            <select id="service_by" name="service_by">
              <option value="">Select a technician</option>
            </select>
          </div>
          <div class="form-group">
            <label for="work_type">Work Type</label>
            <select id="work_type" name="work_type">
              <option value="sale">Sale</option>
              <option value="service">Service</option>
            </select>
          </div>
          <div class="form-group">
            <label for="item_name_or_number">Item Name/Number</label>
            <input type="text" id="item_name_or_number" name="item_name_or_number">
          </div>
          <div class="form-group">
            <label for="issue">Issue Description</label>
            <textarea id="issue" name="issue" rows="7"></textarea>
          </div>
        </div>

        <!-- Column 3 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="photos_of_item">Upload Photo</label>
            <div class="file-input-container">
                <input type="file" id="photos_of_item" name="photos_of_item" multiple>
                <div id="fileNamesDisplay" class="file-names-display">No files selected</div>
            </div>
        </div>
          <div class="form-group">
            <label for="estimation_document">Upload Document</label>
            <input type="file" id="estimation_document" name="estimation_document">
          </div>
          <div class="form-group">
            <label for="estimated_price">Estimated Price</label>
            <input type="text" id="estimated_price" name="estimated_price">
          </div>
          <div class="form-group">
            <label for="estimated_date">Estimated Date</label>
            <input type="date" id="estimated_date" name="estimated_date">
          </div>
          <div class="form-group">
            <label for="any_other_comments">Comments</label>
            <textarea id="any_other_comments" name="any_other_comments"></textarea>
          </div>
        </div>
      </div>
      <div class="form-submit">
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
</div>


  <!-- Table Section -->
  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer Name</th>
          <th>Address</th>
          <th style="width: 18%;">Contact Details</th> <!-- Increased width -->
          <th>Referred By</th>
          <th>Work Type</th>
          <th>Item Name/Number</th>
          <th colspan="2">Issue</th> <!-- Two-column width space -->
          <th>Estimated Price</th>
          <th>Estimated Date</th>
          <th>Service By</th>
          <th style="width: 20%;">Files</th>
          <th>Comments</th>
          <th>Status</th> 
        </tr>
      </thead>
      <tbody>
        {% for service in technician_customers %}
        <tr>
          <td>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
              <span>{{ service.id }}</span> <!-- Display ID on the first line, centered -->
              <div style="display: flex; margin-top: 5px;">
                
                  
                  </button>
                </form>
              </div>
            </div>
          </td>
          
          <td>{{ service.name }}</td>
          <td>{{ service.address }}</td>
          <td>
            <!-- Handle Contact Number -->
            <div>
              <i class="fa fa-phone" aria-hidden="true"></i> 
              {% if service.contact_number|slice:":1" == "+" %}
                {{ service.contact_number|slice:"3:" }}
              {% else %}
                {{ service.contact_number }}
              {% endif %}
            </div>
            <!-- Handle WhatsApp Number -->
            <div>
              <i class="fab fa-whatsapp" aria-hidden="true"></i> 
              {% if service.whatsapp_number|slice:":1" == "+" %}
                {{ service.whatsapp_number|slice:"3:" }}
              {% else %}
                {{ service.whatsapp_number }}
              {% endif %}
            </div>
          </td>
          <td>{{ service.referred_by }}</td>
          <td>{{ service.get_work_type_display }}</td>
          <td>{{ service.item_name_or_number }}</td>
          <td colspan="2">{{ service.issue }}</td> <!-- Span across two columns -->
          <td>{{ service.estimated_price }}</td>
          <td>{{ service.estimated_date }}</td>
          <td>{{ service.service_by.username }}</td>
          <td>
            <ul class="files-list">
      {% if service.estimation_document %}
        <li><a href="{{ service.estimation_document.url }}" target="_blank">Document</a>
          {% endif %}
      {% if service.get_photos %}
          <a href="{{ MEDIA_URL }}{{ service.get_photos.0 }}" data-lightbox="gallery-{{ service.id }}" data-title="Service Photos">Photo</a>

          {% for photo in service.get_photos|slice:"1:" %}
            <a href="{{ MEDIA_URL }}{{ photo }}" data-lightbox="gallery-{{ service.id }}" style="display: none;"></a>
          {% endfor %}
      {% endif %}

              <div class="icon-container">
                <a href="#" class="icon-link">
                  <i class="bi bi-info-square-fill" aria-hidden="true"></i>

                  <a href="#" class="icon-link" onclick="toggleDropdown(event, '{{ service.id }}')">
                    <i class="bi bi-plus-square-fill" aria-hidden="true"></i>
                </a>
                <div class="dropdown-menu" id="dropdown-{{ service.id }}">
                  <a href="#" class="dropdown-item" onclick="openFuelChargeModal()">Fuel Charge</a>
                  <a href="#" class="dropdown-item"  onclick="openFoodAllowanceModal()">Food Allowance</a>
                  <a href="#" class="dropdown-item" onclick="openItemPurchasedModal()">Item Purchased</a>
                  <a href="#" class="dropdown-item" onclick="openVendorInfoModal()">Vendor Info</a>
              </div>
              </div>
                         
            </ul>
          </td>
          <td>{{ service.any_other_comments }}</td>
        
          <td>
            {% if service.current_status_entries.last %}
              <button 
                class="btn btn-sm 
                  {% if service.current_status_entries.last.status == 'Assigned' %}btn-primary{% endif %}
                  {% if service.current_status_entries.last.status == 'Pending' %}btn-danger{% endif %}
                  {% if service.current_status_entries.last.status == 'Completed' %}btn-success{% endif %}"
                
                onclick="openUpdateStatusModal({{ service.id }})"
                data-estimated-date="{{ service.estimated_date|date:'Y-m-d' }}"  
                data-current-status="{{ service.current_status_entries.last.status }}"
                data-service-id="{{ service.id }}" 
                id="statusButton{{ service.id }}">
                {{ service.current_status_entries.last.status }} <!-- Show current status -->
              </button>
            {% else %}
              <span class="text-muted">No status available</span>
            {% endif %}
        </td>
        
        
      </tr>
      
<!-- Update Status Modal -->
{% if service.current_status_entries.last %}
    <div class="modal " id="updateStatusModal{{ service.id }}">
        <div class="modal-dialog" >
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Status</h5>
                    <button type="button" class="close" onclick="closeUpdateStatusModal( {{service.id }} )">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'update_current_status' service.current_status_entries.last.id %}" method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="technician_name{{ service.id }}" class="form-label">Technician Name</label>
                            <input type="text" class="form-control" id="technician_name{{ service.id }}" name="technician_name" value="{{ request.user.username }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="date{{ service.id }}" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date{{ service.id }}" name="date" value="{{ service.estimated_date|date:'Y-m-d'|default:'' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="status{{ service.id }}" class="form-label">Status</label>
                            <select class="form-control" id="status{{ service.id }}" name="status" required>
                                <option value="Assigned" {% if service.current_status_entries.last.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                                <option value="Pending" {% if service.current_status_entries.last.status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Completed" {% if service.current_status_entries.last.status == 'Completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% endfor %}
</tbody>
  </table>
</div>



<!-- Fuel Charge Modal -->
<div class="modal" id="fuelChargeModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Fuel Charge</h5>
        <button type="button" class="close" onclick="closeFuelChargeModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'save_fuel_charge' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="technician_name">Technician Name</label>
            <input type="text" class="form-control" name="technician_name" required>
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="form-group">
            <label for="purpose">Purpose</label>
            <textarea class="form-control" name="purpose" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="kilometers">Kilometers</label>
            <input type="number" step="0.01" class="form-control" name="kilometers" required>
          </div>
          <div class="form-group">
            <label for="cost">Cost</label>
            <input type="number" step="0.01" class="form-control" name="cost" required>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Food Allowance Modal -->
<div class="modal" id="foodAllowanceModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Food Allowance</h5>
        <button type="button" class="close" onclick="closeFoodAllowanceModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'save_food_allowance' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="technician_name">Technician Name</label>
            <input type="text" class="form-control" name="technician_name" required>
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="form-group">
            <label for="purpose">Purpose</label>
            <textarea class="form-control" name="purpose" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="cost">Cost</label>
            <input type="number" step="0.01" class="form-control" name="cost" required>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Item Purchased Modal -->
<div class="modal" id="itemPurchasedModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Item Purchased</h5>
        <button type="button" class="close" onclick="closeItemPurchasedModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data" action="{% url 'save_item_purchased' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="form-group">
            <label for="item_name">Item Name</label>
            <input type="text" class="form-control" name="item_name" required>
          </div>
          <div class="form-group">
            <label for="price">Price</label>
            <input type="number" step="0.01" class="form-control" name="price" required>
          </div>
          <div class="form-group">
            <label for="bill_photo">Bill Photo</label>
            <input type="file" class="form-control" name="bill_photo" required>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Vendor Info Modal -->
<div class="modal" id="vendorInfoModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Vendor Info</h5>
        <button type="button" class="close" onclick="closeVendorInfoModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data" action="{% url 'save_vendor_info' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="form-group">
            <label for="vendor_name">Vendor Name</label>
            <input type="text" class="form-control" name="vendor_name" required>
          </div>
          <div class="form-group">
            <label for="vendor_bill_photo">Vendor Bill Photo</label>
            <input type="file" class="form-control" name="vendor_bill_photo" required>
          </div>
          <div class="form-group">
            <label for="vendor_eta">Vendor ETA</label>
            <input type="date" class="form-control" name="vendor_eta" required>
          </div>
          <div class="form-group">
            <label for="vendor_cost">Vendor Cost</label>
            <input type="number" step="0.01" class="form-control" name="vendor_cost" required>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
</div>

<!-- The Modal Add Customer-->
<div class="modal" id="customerModal" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Customer</h5>
        <button type="button" class="close" onclick="closeCustomerModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data" action="{% url 'technician_add_customer' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="name">Name:</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          <div class="form-group">
            <label for="contact_number">Contact Number:</label>
            <input type="text" class="form-control" id="contact_number" name="contact_number" required>
          </div>
          <div class="form-group">
            <label for="whatsapp_number">WhatsApp Number:</label>
            <input type="text" class="form-control" id="whatsapp_number" name="whatsapp_number">
          </div>
          <div class="form-group">
            <label for="address">Address:</label>
            <input type="text"  class="form-control" id="address" name="address">
          </div>
          
          <div class="form-group">
            <label for="referred_by">Referred By:</label>
            <input type="text" class="form-control" id="referred_by" name="referred_by">
          </div>
          <button type="submit" class="btn btn-primary">Save</button>     
        </form>
      </div>
    </div>
  </div>
</div>




<script>
    function openUpdateStatusModal(serviceId) {
        let modal = document.getElementById("updateStatusModal" + serviceId);
        if (modal) {
            modal.style.display = "block";
        } else {
            console.error("Modal NOT found for Service ID:", serviceId);
        }
    }

    function closeUpdateStatusModal(serviceId) {
        let modal = document.getElementById("updateStatusModal" + serviceId);
        if (modal) {
            modal.style.display = "none";
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        let modals = document.querySelectorAll("[id^='updateStatusModal']");
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });
    };
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
      const statusButtons = document.querySelectorAll('button[id^="statusButton"]');
  
      statusButtons.forEach((button) => {
          const estimatedDate = new Date(button.dataset.estimatedDate);
          const currentStatus = button.dataset.currentStatus;
          const currentDate = new Date();
          const applyId = button.dataset.serviceId; // Correct: Get apply ID
  
          // Check if the status is 'Assigned' and the current date is greater than the estimated date
          if (currentStatus === 'Assigned' && currentDate > estimatedDate) {
            // Update the button styles and text
            button.classList.remove('btn-primary');
            button.classList.add('btn-danger');
            button.textContent = 'Pending';

            // Perform the fetch request to update the status
            fetch(`/update-status/${applyId}/`, {  // Ensure URL uses applyId
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',  // CSRF token for security
                },
                body: JSON.stringify({
                    status: 'Pending',  // Sending the status as "Pending"
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Status updated successfully:", data);
                // Optionally update the UI further based on the response if needed
            })
            .catch(error => {
                console.error('Error updating status:', error);
                alert("Failed to update status. Please try again.");
            });
        }
    });
  });
     
</script>

<script>
  // for add customer
  // Open the modal
  function openCustomerModal() {
      document.getElementById("customerModal").style.display = "block";
  }

  // Close the modal
  function closeCustomerModal() {
      document.getElementById("customerModal").style.display = "none";
  }

  // Close modal if clicking outside of the modal dialog
  window.onclick = function(event) {
      if (event.target == document.getElementById("customerModal")) {
          closeCustomerModal();
      }
  }
</script>

<script>

  function openFuelChargeModal() {
    document.getElementById("fuelChargeModal").style.display = "block";
  }
  
  function closeFuelChargeModal() {
    document.getElementById("fuelChargeModal").style.display = "none";
  }
  
  function openFoodAllowanceModal() {
    document.getElementById("foodAllowanceModal").style.display = "block";
  }
  
  function closeFoodAllowanceModal() {
    document.getElementById("foodAllowanceModal").style.display = "none";
  }
  
  function openItemPurchasedModal() {
    document.getElementById("itemPurchasedModal").style.display = "block";
  }
  
  function closeItemPurchasedModal() {
    document.getElementById("itemPurchasedModal").style.display = "none";
  }
  
  function openVendorInfoModal() {
    document.getElementById("vendorInfoModal").style.display = "block";
  }
  
  function closeVendorInfoModal() {
    document.getElementById("vendorInfoModal").style.display = "none";
  }
  
</script>

<script>
  //for vendor info
  // Open the modal
  function openVendorInfoModal() {
    document.getElementById("vendorInfoModal").style.display = "block";
  }

  // Close the modal
  function closeVendorInfoModal() {
    document.getElementById("vendorInfoModal").style.display = "none";
  }
</script>

<script>
  //for item Purchased
  // Open the modal
  function openItemPurchasedModal() {
    document.getElementById("itemPurchasedModal").style.display = "block";
  }

  // Close the modal
  function closeItemPurchasedModal() {
    document.getElementById("itemPurchasedModal").style.display = "none";
  }
</script>

<script>
  // for food allowance
  // Open the modal
  function openFoodAllowanceModal() {
    document.getElementById("foodAllowanceModal").style.display = "block";
  }

  // Close the modal
  function closeFoodAllowanceModal() {
    document.getElementById("foodAllowanceModal").style.display = "none";
  }
</script>

<script>
  //for fuel charge
 // Function to close the modal
function closeFuelChargeModal() {
    var modal = document.getElementById('fuelChargeModal');
    modal.style.display = 'none';  // Hides the modal
}

// Function to open the modal
function openFuelChargeModal() {
    var modal = document.getElementById('fuelChargeModal');
    modal.style.display = 'block';  // Shows the modal
}

// Close the modal when clicking outside of it
window.onclick = function(event) {
    var modal = document.getElementById('fuelChargeModal');
    if (event.target == modal) {
        closeFuelChargeModal();
    }
}

</script>

 <!-- Bootstrap 5 JS -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 <script>
   // Function to toggle the sidebar visibility
   function toggleSidebar() {
     const sidebar = document.querySelector('.sidebar');
     sidebar.classList.toggle('show');
   }
   const notFoundDiv = document.getElementById('customer_not_found');
  const resultsDiv = document.getElementById('customer_results'); 

function searchCustomer() {
  const query = document.getElementById('contact_number').value;

  console.log('Search query:', query); // Debugging
  
  resultsDiv.innerHTML = ''; // Clear previous results
  notFoundDiv.style.display = 'none'; 

  fetch(`/technician/search_customer/?q=${query}`)
    .then(response => response.json())
    .then(data => {
      console.log('Search results:', data);
      if (data.exists) {
                // Autofill the fields if the customer exists
                data.results.forEach(customer => {
                    const div = document.createElement('div');
                    div.textContent = `${customer.name} - ${customer.contact_number}`;
                    div.onclick = () => selectCustomer(customer);
                    resultsDiv.appendChild(div);
                });
            } else {
                // Enable the fields for manual input if the customer doesn't exist
                enableManualInput();
                notFoundDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching customer data:', error);
            resultsDiv.innerHTML = '<div>Error loading results. Please try again later.</div>';
            notFoundDiv.style.display = 'none'; 
        });
}

function enableManualInput() {
    // Enable the fields for manual input
    document.getElementById('name').readOnly = false;
    document.getElementById('address').readOnly = false;
    document.getElementById('whatsapp_number').readOnly = false;
    document.getElementById('referred_by').readOnly = false;
}

function copyContactToWhatsApp() {
    const sameAsContact = document.getElementById('same_as_contact');
    const customerNumber = document.getElementById('contact_number'); // Use customer_number
    const whatsappNumber = document.getElementById('whatsapp_number');

    if (sameAsContact.checked) {
        whatsappNumber.value = customerNumber.value; // Copy customer number to WhatsApp number
    } else {
        whatsappNumber.value = ''; // Clear WhatsApp number if unchecked
    }
}

function selectCustomer(customer) {
    // Autofill the fields when a customer is selected
    document.getElementById('contact_number').value = customer.contact_number;
    document.getElementById('name').value = customer.name;
    document.getElementById('address').value = customer.address;
    document.getElementById('whatsapp_number').value = customer.whatsapp_number;
    document.getElementById('referred_by').value = customer.reffered_by;

    // Make the fields read-only again
    document.getElementById('name').readOnly = true;
    document.getElementById('address').readOnly = true;
    document.getElementById('whatsapp_number').readOnly = true;
    document.getElementById('referred_by').readOnly = true;

    
    // Clear the search results and hide the "not found" message
  document.getElementById('customer_results').innerHTML = '';
  document.getElementById('customer_not_found').style.display = 'none';

}
      
    $(document).ready(function() {
        // Fetch technicians via AJAX
        $.ajax({
            url: '/technician/get_users/',  // URL to the API endpoint
            method: 'GET',
            success: function(data) {
                // Populate the dropdown
                const dropdown = $('#service_by');
                dropdown.empty();  // Clear existing options
                dropdown.append('<option value="">Select a technician</option>');  // Add default option
                data.forEach(function(technician) {
                    dropdown.append(`<option value="${technician.id}">${technician.username}</option>`);
                });
            },
            error: function(error) {
                console.error('Error fetching technicians:', error);
            }
        });
    });

  
    // Handle form submission
    document.getElementById('addServiceForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const form = document.getElementById('addServiceForm');
      const formData = new FormData(this);
      fetch('/technician/add_service/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
            if (data.is_new_customer) {
                alert('Customer and service added successfully!');  // Display this message only for new customers
            } else {
                alert('Service added successfully!');  // Display this message for existing customers
            }
            window.location.reload();  // Optionally reload the page or update the UI
        } else {
            alert('Error: ' + (data.message || JSON.stringify(data.errors)));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again later.');
    });
});

    // Modal handling
    const modal = document.getElementById('addServiceModal');

    // Open the modal
function openModal() {
  document.getElementById('addServiceForm').reset();
  document.getElementById('customer_results').innerHTML = '';
  document.getElementById('name').readOnly = false;
  document.getElementById('address').readOnly = false;
  document.getElementById('whatsapp_number').readOnly = false;
  document.getElementById('referred_by').readOnly = false;
  document.getElementById('addServiceModal').style.display = 'flex';
}

// Close the modal
function closeModal() {
  notFoundDiv.style.display = 'none'; 
  document.getElementById('addServiceModal').style.display = 'none';
}

// Prevent closing when clicking outside the modal
document.getElementById('addServiceModal').addEventListener('click', function (event) {
  if (event.target === this) {
    event.stopPropagation(); // Prevent closing
  }
});

    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
    }

  </script>
  
 <script>
  function toggleDropdown(event, id) {
    // Prevent the click from closing the dropdown immediately
    event.stopPropagation();
  
    // Find the dropdown menu by ID
    const dropdownMenu = document.getElementById(`dropdown-${id}`);
    const allDropdowns = document.querySelectorAll('.dropdown-menu');
  
    // Hide all other dropdowns
    allDropdowns.forEach((dropdown) => {
      if (dropdown !== dropdownMenu) {
        dropdown.style.display = 'none';
      }
    });
  
    // Toggle the current dropdown
    if (dropdownMenu.style.display === 'block') {
      dropdownMenu.style.display = 'none';
    } else {
      dropdownMenu.style.display = 'block';
    }
  }
  
  // Close dropdowns if clicked outside
  document.addEventListener('click', () => {
    const allDropdowns = document.querySelectorAll('.dropdown-menu');
    allDropdowns.forEach((dropdown) => {
      dropdown.style.display = 'none';
    });
  });
</script>
<!-- Lightbox JS -->
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2.11.3/dist/js/lightbox.min.js"></script>
<script>
  const fileInput = document.getElementById('photos_of_item');
  const fileNamesDisplay = document.getElementById('fileNamesDisplay');
  let selectedFiles = new DataTransfer();

  fileInput.addEventListener('change', function(e) {
      // Add new files to existing selection
      Array.from(this.files).forEach(file => {
          selectedFiles.items.add(file);
      });
      
      // Update the input's files
      fileInput.files = selectedFiles.files;
      
      // Update display
      updateFileNames();
  });

  function removeFile(index, event) {
      event.stopPropagation();
      const newFiles = new DataTransfer();
      Array.from(selectedFiles.files)
          .filter((file, i) => i !== index)
          .forEach(file => newFiles.items.add(file));
      
      selectedFiles = newFiles;
      fileInput.files = selectedFiles.files;
      updateFileNames();
  }

  function updateFileNames() {
      if (selectedFiles.files.length === 0) {
          fileNamesDisplay.textContent = 'No files selected';
      } else {
          fileNamesDisplay.innerHTML = '';
          Array.from(selectedFiles.files).forEach((file, index) => {
              const fileItem = document.createElement('div');
              fileItem.className = 'file-item';
              fileItem.innerHTML = `
                  <span class="file-name">${file.name}</span>
                  <span class="delete-btn" onclick="removeFile(${index}, event)">×</span>
              `;
              fileNamesDisplay.appendChild(fileItem);
          });
      }
  }
</script>
</body>
</html>